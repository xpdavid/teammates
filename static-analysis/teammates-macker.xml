<?xml version="1.0"?>
<macker>
    <ruleset name="packageDiagram: UI should not touch storage">
        <access-rule>
            <deny>
                <from class="teammates.ui.*" />
                <to class="teammates.storage.*" />
            </deny>
        </access-rule>
    </ruleset>
    <ruleset name="packageDiagram: Logic should not touch UI">
        <access-rule>
            <deny>
                <from class="teammates.logic.*" />
                <to class="teammates.ui.*" />
            </deny>
        </access-rule>
    </ruleset>
    <ruleset name="packageDiagram: Storage should not touch Logic">
        <access-rule>
            <deny>
                <from class="teammates.storage.*" />
                <to class="teammates.logic.*" />
            </deny>
        </access-rule>
    </ruleset>
    <ruleset name="packageDiagram: Storage should not touch UI">
        <access-rule>
            <deny>
                <from class="teammates.storage.*" />
                <to class="teammates.ui.*" />
            </deny>
        </access-rule>
    </ruleset>
    <ruleset name="packageDiagram: client::remoteapi can be only access by client::scripts">
        <access-rule>
            <deny>
                <to class="teammates.client.remoteapi.*" />
                <allow>
                    <from class="teammates.client.scripts.*" />
                </allow>          
            </deny>
        </access-rule>
    </ruleset>
    <ruleset name="packageDiagram: client::util should only be used inside client">
        <access-rule>
            <deny>
                <to class="teammates.client.util.*" />
                <allow>
                    <from class="teammates.client.*" />
                </allow>          
            </deny>
        </access-rule>
    </ruleset>
    
    <ruleset name="LogicComponent: Each logic can only access its corresponding DB (e.g. AccountsLogic -> AccountsDb)">
        <foreach var="logicModule" class="teammates.logic.core.(*)Logic">
            <pattern name="DbModule" class="teammates.storage.api.${logicModule}Db" />
            
            <access-rule>  
                <message>${logicModule} can only access its corresponding DB</message>
                <deny> 
                    <from class="teammates.logic.core.${logicModule}Logic" />
                    <to class="teammates.storage.api.*" /> 
                    <allow>
                        <to pattern="DbModule"></to>
                    </allow>
                </deny>
            </access-rule>
        </foreach>
    </ruleset>
    <ruleset name="packageDiagram: BackDoorServlet should only access BackDoorLogic, not logic:core">
        <access-rule>
            <deny>
                <from class="teammates.logic.backdoor.BackDoorServlet" />
                <to class="teammates.logic.core.*" />      
            </deny>
        </access-rule>
    </ruleset>
    
    <ruleset name="StorageComponent: storage::entity should only be accessed by storage::api and common:datatransfer">
       <access-rule>
            <deny>
                <to class="teammates.storage.entity.*" />
            </deny>
            <allow>
                <from>
                    <include class="teammates.test.**" />
                    <include class="teammates.client.**" />
                    <include class="teammates.storage.entity.*" />
                    <include class="teammates.storage.api.*" />
                    <include class="teammates.common.datatransfer.**" />
                </from>
            </allow>
            <allow>
                <!-- Should update this later -->
                <to class="teammates.storage.entity.FeedbackResponse" />
            </allow>
        </access-rule>
    </ruleset>
    <ruleset name="StorageComponent: storage::search should only be accessed by storage::api">
        <access-rule>
            <deny>
                <to class="teammates.storage.search.*" />
                <allow>
                    <from>
                        <include class="teammates.test.**" />
                        <include class="teammates.storage.api.*" />
                        <include class="teammates.storage.search.*" />
                    </from>
                </allow>    
            </deny>
        </access-rule>
    </ruleset>
    
    <ruleset name="TestDriverComponent: Test cases should not be dependent on each other">
        <var name="testCasesPackage" value="teammates.test.cases" />
        <access-rule>
            <deny>
                <from class="${testCasesPackage}.**" />
                <to class="${testCasesPackage}.**" />
                <allow>
                    <!-- allow dependency from inner class -->
                    <from class="${testCasesPackage}.**$**" />
                </allow>
                <allow>
                    <!-- allow dependency to inner class -->
                    <to class="${testCasesPackage}.**$**" />
                </allow>
                <allow>
                    <!-- allow dependency to base class -->
                    <to class="${testCasesPackage}.**Base**" />
                </allow>
                <allow>
                    <!-- allow dependency from Feedback*QuestionUiTest to FeedbackQuestionUiTest -->
                    <from class="${testCasesPackage}.browsertests.Feedback*QuestionUiTest" />
                    <to class="${testCasesPackage}.browsertests.FeedbackQuestionUiTest" />
                </allow>
            </deny>
        </access-rule>
    </ruleset>
    <ruleset name="TestDriverComponent: Only UI tests can access page object classes">
        <access-rule>
            <deny>
                <from class="teammates.test.**" />
                <to class="teammates.test.pageobjects.*" />
                <allow>
                    <!-- allow dependency within the package -->
                    <from class="teammates.test.pageobjects.*" />
                </allow>
                <allow>
                    <!-- allow dependency from UI tests -->
                    <from class="teammates.test.cases.browsertests.*" />
                </allow>
            </deny>
        </access-rule>
    </ruleset>
    <ruleset name="TestDriverComponent: Test driver can only be accessed from test package">
        <access-rule>
            <deny>
                <from class="teammates.**" />
                <to class="teammates.test.driver.*" />
                <allow>
                    <from class="teammates.test.**" />
                </allow>
                <allow>
                    <!-- Is this allowed? -->
                    <from class="teammates.client.**" />
                </allow>
            </deny>
        </access-rule>
    </ruleset>
    <ruleset name="TestDriverComponent: util and browsertest cannot access GaeSimulation">
        <access-rule>
            <deny>
                <from>
                    <include class="teammates.test.cases.util.*" />
                    <include class="teammates.test.cases.browsertests.*" />
                </from>
                <to class="teammates.test.driver.GaeSimulation" />
            </deny>
        </access-rule>
    </ruleset>
<!--     <ruleset name="TestDriverComponent: action test cases should only interact with back-end through BackDoor API">
        <access-rule>
            <deny>
                <from class="teammates.test.cases.action.*" />
                <to class="teammates.logic.**" />
                <allow>
                    <to class="teammates.logic.backdoor.BackDoorLogic" />
                </allow>
            </deny>
        </access-rule>
    </ruleset> --> 
</macker>
